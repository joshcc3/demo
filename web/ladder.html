<html>
<head>
    <title>ladder</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="js/jquery-1.4.2.js"></script>
    <script src="js/websocket.js"></script>
    <script src="js/websocket-ui.js"></script>
    <script src="js/sound-files.js"></script>
    <script src="js/sound-player.js"></script>
    <script src="js/sounds.js"></script>
    <script src="fastui.js"></script>
    <script src="launcher.js"></script>
    <script>

        var handler;

        // Handler for incoming data

        function draw(levels) {
            var ladder = $("#ladder");
            var rows = $("#rows");
            rows.find(".row").remove();
            for (var i = 0; i < levels; i++) {
                var row = $("#row_template").clone().removeClass("template");
                row.attr('id', 'row_' + i);
                row.find('.order').attr('id', 'order_' + i).text(' ');
                row.find('.bid').attr('id', 'bid_' + i).text(' ');
                row.find('.price').attr('id', 'price_' + i).text(' ');
                row.find('.offer').attr('id', 'offer_' + i).text(' ');
                row.find('.trade').attr('id', 'trade_' + i).text(' ');
                row.find('.volume').attr('id', 'volume_' + i).text(' ');
                row.find('.text').attr('id', 'text_' + i).text(' ');
                rows.append(row);
            }
        }


        function trading(clickTrading, orderTypesLeft, orderTypesRight) {

            $("#clicktrading").toggleClass("invisible", !clickTrading);

            if (!clickTrading) {
                return;
            }

            $("#order_type_left").each(function (i, el) {
                $(el).find("option").remove();
                orderTypesLeft.forEach(function (orderType) {
                    var option = $("<option value=\"" + orderType + "\">" + orderType + "</option>");
                    option.addClass(orderType);
                    $(el).append(option);
                });
            });

            $("#order_type_right").each(function (i, el) {
                $(el).find("option").remove();
                orderTypesRight.forEach(function (orderType) {
                    var option = $("<option value=\"" + orderType + "\">" + orderType + "</option>");
                    option.addClass(orderType);
                    $(el).append(option);
                });
            });

            $("input[type=text]").each(function (i, el) {
                handler.updateOn(el, 'keyup');
            });

            $("input[type=checkbox]").each(function (i, el) {
                handler.updateOn(el, 'click');
            });

            $("select").each(function (i, el) {
                handler.updateOn(el, 'change');
            });


        }

        function setData(elementId, key, value) {
            if (!Data[elementId]) {
                Data[elementId] = {};
            }
            Data[elementId][ key] = value;
        }

        function calcLevels() {
            return parseInt(($(window).height() - 44) / 15);
        }

        var NumLevels = 0;

        function subscribe() {

	        var symbolEnd = document.location.hash.indexOf(';', 0);
	        if ( symbolEnd < 0 ) {
		        symbolEnd = document.location.hash.length;
	        }
            var symbol = document.location.hash.substr(1, symbolEnd -1);
            NumLevels = calcLevels();
            draw(NumLevels);
	        if (0 < symbolEnd) {
		        var price = document.location.hash.substr(symbolEnd + 1);
		        handler.send("ladder-subscribe", symbol, NumLevels, price);
	        } else {
		        handler.send("ladder-subscribe", symbol, NumLevels);
	        }
            window.addEventListener("hashchange", function () {
                window.location.reload();
            }, false);
        }

        function resizeIfNecessary() {
            if (calcLevels() != NumLevels) {
                subscribe();
            }
        }

        function goToSymbol(symbol) {
            document.location.hash = "#" + symbol;
        }

        function goToUrl(url) {
            window.location.href = url;
        }

        $(function () {
            ws = connect();
            ws.logToConsole = false;
            handler = new Handler(ws);
            ws.onmessage = handler.msg;
            handler.heartbeat = function(args) {
                handler.send(args[0],args[1],args[2]);
            };
            subscribe();
            setInterval(resizeIfNecessary, 200);
        });

    </script>
</head>
<body>
<div id="click_trading_issues" title="Ladder Click Trading Issues"></div>
<div id="row_template" class="row template">
    <div class="order column"></div>
    <div class="bid column"></div>
    <div class="price column"></div>
    <div class="offer column"></div>
    <div class="trade column invisible"></div>
    <div class="volume column"></div>
    <div class="text column invisible"></div>
</div>
<div id="workspace">
    <div id="information">
        <div id="clock" title="Clock/Switch to Chi-X"></div>
        <div id="desk_position" title="Desk Position"></div>
        <div id="last_trade_cod" title="Last print change on day">?</div>
        <div id="total_traded_volume" title="Total traded volume">?</div>
        <div id="position" title="Day Position">?</div>
    </div>
    <div id="clicktrading">
	    <select id="working_order_tags">
		    <option value="CHAD">CHAD</option>
		    <option value="DIV">DIV</option>
		    <option value="STRING">STRING</option>
            <option value="CLICKNOUGHT">CLICKNOUGHT</option>
	    </select>
        <input type="text" id="inp_qty" value="0"/>
        <button id="btn_qty_1" class="quantity_button col_1 row_1"></button>
        <button id="btn_qty_2" class="quantity_button col_2 row_1"></button>
        <button id="btn_qty_3" class="quantity_button col_1 row_2"></button>
        <button id="btn_qty_4" class="quantity_button col_2 row_2"></button>
        <button id="btn_qty_5" class="quantity_button col_1 row_3"></button>
        <button id="btn_qty_6" class="quantity_button col_2 row_3"></button>
        <button id="btn_clear">CLR</button>
        <input id="inp_reload" type="text" value="50"/>
        <select class="order_type" id="order_type_left"></select>
        <input type="checkbox" id="chk_auto_hedge_left" checked="checked"/>
        <select class="order_type" id="order_type_right"></select>
        <input type="checkbox" id="chk_auto_hedge_right" checked="checked"/>

        <div id="random_reload">
            RR <input type="checkbox" id="chk_random_reload" checked="checked"/>
        </div>
        <div id="offset_control" class="invisible">
            <button id="buy_offset_up" class="offset_button">&nbsp;</button>
            <button id="buy_offset_down" class="offset_button">&nbsp;</button>
            <button id="sell_offset_up" class="offset_button">&nbsp;</button>
            <button id="sell_offset_down" class="offset_button">&nbsp;</button>
            <button id="start_buy" class="offset_button">&nbsp;</button>
            <button id="stop_buy" class="offset_button">&nbsp;</button>
            <button id="start_sell" class="offset_button">&nbsp;</button>
            <button id="stop_sell" class="offset_button">&nbsp;</button>
        </div>
    </div>
    <div id="pricing_control">
        <button id="pricing_BPS" class="pricing_button">BPS</button>
        <button id="pricing_EFP" class="pricing_button">EFP</button>
        <button id="pricing_RAW" class="pricing_button">RAW</button>
    </div>
    <div id="ladder">
        <div id="header">
            <div id="buy_qty" class="total_qty invisible"></div>
            <div id="symbol"></div>
            <div id="sell_qty" class="total_qty invisible"></div>
        </div>
        <div id="text">
            <div id="text_r1c1" class="text_cell"></div>
            <div id="text_r1c2" class="text_cell"></div>
            <div id="text_r1c3" class="text_cell"></div>
            <div id="text_r1c4" class="text_cell"></div>
            <div id="text_info" class="text_cell"></div>
            <div id="text_r2c1" class="text_cell"></div>
            <div id="text_r2c2" class="text_cell"></div>
            <div id="text_r2c3" class="text_cell"></div>
            <div id="text_r2c4" class="text_cell"></div>
            <div id="text_r2c5" class="text_cell"></div>
        </div>
        <div id="rows">
            <div id="laser_bid" class="laser bid_color invisible"></div>
            <div id="laser_offer" class="laser offer_color invisible"></div>
            <div id="laser_green" class="laser green_color invisible"></div>
        </div>
    </div>
</div>
</body>
</html>
