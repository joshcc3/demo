<html>
<head>
    <title>workspace</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        div.ladder {
            float: left;
            border: 1px solid #d4d0c7;
            margin: 1px;;
        }

        div.ladder:hover {
            border: 1px solid yellow;
        }

        iframe {
            border: none;
        }

        #options {
            position: absolute;
            left: 0px;
            top: 0px;
            width: 4px;
            height: 4px;
            border: 1px solid green;
            overflow: hidden;
            background-color: green;
        }

        #options:hover {
            width: 50px;
            height: 25px;
            border: 1px solid yellow;
        }

        button.enabled {
            background-color: red;
        }

        button {
            width: 20px;
            height: 20px;
            font-size: 8px;
        }

    </style>
    <script src="js/jquery-1.4.2.js"></script>
    <script src="js/websocket.js"></script>
    <script src="js/websocket-ui.js"></script>
    <script src="js/sound-files.js"></script>
    <script src="js/sound-player.js"></script>
    <script src="js/sounds.js"></script>
    <script src="cell-functions.js"></script>
    <script src="popup.js"></script>
    <script>

        var ws;

        var ladderWidth = 245;
        var ladderHeight = 332;

        ws = connect("ws://" + document.location.host + "/workspace/ws/");
        ws.logToConsole = false;
        ws.onmessage = function (x) {
            eval(x);
        };

        var LastRows = 0;
        var LastCols = 0;
        var NumBoxes = LastRows * LastCols;

        var Frames = [];
        var Ladders = {};
        var Locked = false;
        var Sets = false;

        $(function () {

            var parameters = parseHashcode();


            if (parameters.locking) {
                toggleLock();
            }

            if (parameters.sets) {
                toggleSets();
            }

            setInterval(function () {

                // Compute number of rows and columns
                var height = $(window).height();
                var width = $(window).width();

                var rows = parseInt(height / ladderHeight);
                var cols = parseInt(width / ladderWidth);

                if (rows != LastRows || cols != LastCols) {
                    LastRows = rows;
                    LastCols = cols;
                    NumBoxes = LastRows * LastCols;

                    doLayout();
                    doLadders();
                    return;
                }


            }, 250);

            $("#lock").click(function () {
                toggleLock();
            });

            $("#sets").click(function () {
                toggleSets();
            });

            window.onhashchange = function () {
                doLadders();
            }

        });

        function refreshHashCode() {
            var params = parseHashcode();
            document.location.hash = generateHashcode(params.symbols);
        }

        function doLayout() {

            var template = $('.ladder.template').clone().removeClass('template');
            template.width(ladderWidth);
            template.height(ladderHeight);

            var existing = $('.ladder:not(.template)');
            var numExisting = existing.size();

            if (numExisting > NumBoxes) {
                var spliced = Frames.splice(NumBoxes);
                spliced.forEach(function (frame) {
                    frame.remove();
                });
            }

            for (var i = numExisting; i < NumBoxes; i++) {
                var frame = template.clone();
                $('#workspace').append(frame);
                Frames.push(frame);
            }

        }

        function doLadders() {
            var parameters = parseHashcode();
            var symbols = parameters.symbols;
            console.log(symbols);
            for (var i = 0; i < Math.min(symbols.length, Frames.length); i++) {
                setFrame(Frames[i], symbols[i]);
            }
        }

        function moveFrameToFront(index) {
            if (index == 0) {
                return;
            }
            if (index < Frames.length) {
                var el = Frames[index];
                Frames.splice(index, 1);
                Frames.unshift(el);
                el.detach();
                $("#workspace").prepend(el);
            }
        }

        function addSymbol(symbol) {
            var parameters = parseHashcode();
            var symbols = parameters.symbols;
            if (symbols.indexOf(symbol) != -1) {
                // Move the symbol to the front and move its frame
                var index = symbols.indexOf(symbol);
                moveFrameToFront(index, Frames);
                symbols.splice(index, 1);
                symbols.unshift(symbol);
            } else {
                // Add the symbol to the front
                symbols.unshift(symbol);
                // Roll the last frame around to the front
                moveFrameToFront(Frames.length - 1, Frames);
            }
            document.location.hash = generateHashcode(symbols);
            doLadders();
        }


        function toggleLock() {
            Locked = !Locked;
            ws.send(command(Locked ? "lock" : "unlock", []));
            $("#lock").toggleClass("enabled", Locked);
            refreshHashCode();
        }


        function toggleSets() {
            Sets = !Sets;
            ws.send(command(Sets ? "setify" : "unsetify", []));
            $("#sets").toggleClass("enabled", Sets);
            refreshHashCode();
        }


        // -- utilities

        function parseHashcode() {
            var hash = document.location.hash.substr(1);
            var symbols, locking, sets;
            locking = hash.indexOf("!") != -1;
            sets = hash.indexOf("*") != -1;
            symbols = hash.split("!").join("").split("*").join("").split(",");
            if (symbols.length == 1 && symbols[0] == "") {
                symbols = [];
            }
            return {symbols: symbols, locking: locking, sets: sets};
        }


        function generateHashcode(symbols) {
            console.log(symbols);
            return symbols.join(",")
                    + (Locked ? "!" : "")
                    + (Sets ? "*" : "");
        }

        function getUrl(symbol) {
            var port = parseInt(document.location.port);
            var host = document.location.hostname;
            return 'http://' + host + ':' + (port - 1) + '/ladder#' + symbol;
        }

        function setFrame(ladder, symbol) {
            if ($(ladder).attr('id') != symbolId(symbol)) {
                $(ladder).find('.frame').attr('src', getUrl(symbol));
                $(ladder).attr('id', symbolId(symbol));
            }
        }

        function symbolId(symbol) {
            return symbol.replace(/\W/g, '_');
        }


    </script>
</head>
<body>

<div id="options">
    <button id="lock">L</button>
    <button id="sets">S</button>
</div>

<div id="workspace">
    <div class="template ladder">
        <iframe class="frame" width="100%" height="100%"></iframe>
    </div>
</div>

</body>
</html>